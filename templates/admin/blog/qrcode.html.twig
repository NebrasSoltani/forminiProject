{% extends 'base.html.twig' %}

{% block title %}QR Code - {{ blog.titre }}{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    .qrcode-container {
        text-align: center;
        padding: 40px;
    }
    .qrcode-box {
        background: white;
        border: 3px solid #007bff;
        border-radius: 15px;
        padding: 30px;
        display: inline-block;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    #qrcode {
        margin: 20px auto;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: transform 0.3s ease;
    }
    #qrcode:hover {
        transform: scale(1.05);
    }
    #qrcode canvas,
    #qrcode img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
    }
    .qrcode-link {
        display: block;
        text-decoration: none;
        color: inherit;
    }
    .blog-info {
        margin-top: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
    }
    .print-btn {
        margin-top: 20px;
    }
    @media print {
        body * {
            visibility: hidden;
        }
        .qrcode-container, .qrcode-container * {
            visibility: visible;
        }
        .qrcode-container {
            position: absolute;
            left: 0;
            top: 0;
        }
        .print-btn {
            display: none !important;
        }
        a.btn {
            display: none !important;
        }
        #qrcode {
            cursor: default;
        }
        #qrcode:hover {
            transform: none;
        }
    }
</style>
{% endblock %}

{% block body %}
<div class="container py-5">
    <div class="row">
        <div class="col-12 text-center mb-4">
            <h1 class="h3">
                <i class="fas fa-qrcode me-2"></i>QR Code du Blog
            </h1>
            <a href="{{ path('admin_blog_index') }}" class="btn btn-secondary mt-2">
                <i class="fas fa-arrow-left me-1"></i> Retour
            </a>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="qrcode-container">
                <div class="qrcode-box">
                    <h4 class="mb-3">{{ blog.titre }}</h4>
                    
                    {# Conteneur cliquable pour le QR Code #}
                    <a href="{{ blogUrl }}" target="_blank" class="qrcode-link" id="qrcode-link">
                        <div id="qrcode"></div>
                    </a>
                    
                    <p class="text-muted mb-0 mt-3">
                        <i class="fas fa-mouse-pointer me-1"></i>Cliquez sur le QR Code pour visiter le blog
                    </p>
                </div>

                <div class="blog-info">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Catégorie :</strong> {{ blog.categorie }}</p>
                            <p><strong>Auteur :</strong> {{ blog.auteur.prenom }} {{ blog.auteur.nom }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Date :</strong> {{ blog.datePublication|date('d/m/Y') }}</p>
                            <p><strong>Statut :</strong> 
                                <span class="badge bg-{{ blog.isPublie ? 'success' : 'warning' }}">
                                    {{ blog.isPublie ? 'Publié' : 'Brouillon' }}
                                </span>
                            </p>
                        </div>
                    </div>
                    <p class="mb-0"><strong>URL :</strong> 
                        <a href="{{ blogUrl }}" target="_blank" class="text-primary">
                            <code>{{ blogUrl }}</code>
                            <i class="fas fa-external-link-alt ms-1"></i>
                        </a>
                    </p>
                </div>

                <div class="print-btn mt-4">
                    <button onclick="window.print()" class="btn btn-primary btn-lg me-3">
                        <i class="fas fa-print me-2"></i>Imprimer le QR Code
                    </button>
                    <button onclick="downloadQRCode()" class="btn btn-success btn-lg me-3">
                        <i class="fas fa-download me-2"></i>Télécharger
                    </button>
                    <button onclick="copyUrl()" class="btn btn-info btn-lg">
                        <i class="fas fa-copy me-2"></i>Copier l'URL
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById("qrcode").innerHTML = "";
    
    // Utiliser l'URL passée depuis le contrôleur
    const blogUrl = "{{ blogUrl|raw }}";
    
    const qrcode = new QRCode(document.getElementById("qrcode"), {
        text: blogUrl,
        width: 256,
        height: 256,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
    });
    
    // Rendre le QR Code cliquable
    const qrcodeElement = document.getElementById("qrcode");
    qrcodeElement.style.cursor = "pointer";
    qrcodeElement.title = "Cliquez pour visiter le blog";
    
    qrcodeElement.addEventListener('click', function() {
        window.open(blogUrl, '_blank');
    });
});

function downloadQRCode() {
    const canvas = document.querySelector('#qrcode canvas');
    if (!canvas) {
        const img = document.querySelector('#qrcode img');
        if (img) {
            const link = document.createElement('a');
            link.download = 'qrcode-blog-{{ blog.id }}-{{ blog.titre|replace({" ":"-"})|lower }}.png';
            link.href = img.src;
            link.click();
        } else {
            alert('Erreur lors de la génération du QR code');
        }
        return;
    }
    
    const url = canvas.toDataURL('image/png');
    const link = document.createElement('a');
    link.download = 'qrcode-blog-{{ blog.id }}-{{ blog.titre|replace({" ":"-"})|lower }}.png';
    link.href = url;
    link.click();
}

function copyUrl() {
    const url = "{{ blogUrl }}";
    navigator.clipboard.writeText(url)
        .then(() => {
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check me-2"></i>Copié!';
            btn.classList.remove('btn-info');
            btn.classList.add('btn-success');
            
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-info');
            }, 2000);
        })
        .catch(err => {
            console.error('Erreur lors de la copie: ', err);
            alert('Impossible de copier l\'URL');
        });
}
</script>
{% endblock %}