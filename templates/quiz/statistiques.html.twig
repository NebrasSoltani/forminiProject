{% extends 'base.html.twig' %}

{% block title %}Statistiques - {{ quiz.titre }}{% endblock %}

{% block body %}
<div class="container py-5">

    <!-- En-tête + boutons d’action -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
        <div>
            <h1 class="h2 mb-1 fw-semibold">Statistiques du quiz</h1>
            <div class="text-muted fs-5">{{ quiz.titre }}</div>
        </div>

        <div class="d-flex flex-wrap gap-3">
            <a href="{{ path('quiz_show', {formationId: formation.id, id: quiz.id}) }}"
               class="btn btn-outline-secondary d-inline-flex align-items-center gap-2 px-4">
                <i class="bi bi-arrow-left"></i>
                Retour
            </a>

            <a href="{{ path('quiz_reussite', {formationId: formation.id, id: quiz.id}) }}"
               class="btn btn-success d-inline-flex align-items-center gap-2 px-4">
                <i class="bi bi-people-fill"></i>
                Voir les apprenants réussis
            </a>
        </div>
    </div>

    <div class="row g-4">

        <!-- Colonne gauche - Résumé -->
        <div class="col-lg-5 col-xl-4">
            <div class="card shadow border-0 h-100">
                <div class="card-header bg-gradient text-white d-flex align-items-center gap-3 py-3"
                     style="background: linear-gradient(90deg, #0d6efd 0%, #4e73df 100%);">
                    <i class="bi bi-bar-chart-line-fill fs-3"></i>
                    <h5 class="mb-0 fw-semibold">Résumé global</h5>
                </div>

                <div class="card-body d-flex flex-column p-4">
                    <ul class="list-group list-group-flush mb-4">
                        <li class="list-group-item d-flex justify-content-between align-items-center py-3 border-0">
                            <div><i class="bi bi-question-circle-fill me-3 text-primary fs-5"></i>Total questions</div>
                            <strong class="fs-5">{{ totalQuestions }}</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center py-3 border-0">
                            <div><i class="bi bi-chat-square-text-fill me-3 text-primary fs-5"></i>Réponses</div>
                            <strong class="fs-5">{{ totalReponses }}</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center py-3 border-0 text-success">
                            <div><i class="bi bi-check-circle-fill me-3 fs-5"></i>Bonnes réponses</div>
                            <strong class="fs-5">{{ bonnesReponses }}</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center py-3 border-0">
                            <div><i class="bi bi-check-lg me-3 text-success fs-5"></i>Questions valides</div>
                            <strong class="text-success fs-5">{{ questionsValides }}</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center py-3 border-0">
                            <div><i class="bi bi-x-circle-fill me-3 text-danger fs-5"></i>Questions invalides</div>
                            <strong class="text-danger fs-5">{{ questionsInvalides }}</strong>
                        </li>
                    </ul>

                    <div class="mt-auto">
                        <h6 class="text-muted mb-3 fw-medium">Taux de validité global</h6>
                        <div class="progress mb-4" style="height: 32px; border-radius: 12px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);">
                            <div class="progress-bar bg-success fw-bold d-flex align-items-center justify-content-center fs-5"
                                 role="progressbar"
                                 style="width: {{ pourcentageValide }}%"
                                 aria-valuenow="{{ pourcentageValide }}"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                                {{ pourcentageValide }}%
                            </div>
                        </div>

                        {% set performance = (bonnesReponses / (totalReponses > 0 ? totalReponses : 1)) * 100 %}
                        <div class="text-center">
                            {% if performance >= 80 %}
                                <span class="badge bg-success-subtle text-success-emphasis px-4 py-2 fs-5 border border-success-subtle">Excellent</span>
                            {% elseif performance >= 50 %}
                                <span class="badge bg-warning-subtle text-warning-emphasis px-4 py-2 fs-5 border border-warning-subtle">Moyen</span>
                            {% else %}
                                <span class="badge bg-danger-subtle text-danger-emphasis px-4 py-2 fs-5 border border-danger-subtle">À travailler</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Colonne droite - Graphiques -->
        <div class="col-lg-7 col-xl-8">
            <div class="row g-4">

                <!-- Taux de réussite principal -->
                <div class="col-12">
                    <div class="card shadow border-0">
                        <div class="card-body text-center p-4">
                            <h5 class="card-title mb-4 fw-semibold">
                                <i class="bi bi-trophy-fill me-2 text-warning fs-4"></i>
                                Taux de réussite global
                            </h5>
                            <div class="bg-light rounded-3 p-3" style="height: 360px; box-shadow: inset 0 2px 6px rgba(0,0,0,0.06);">
                                <canvas id="tauxReussiteChart"></canvas>
                            </div>
                            <div class="mt-3 text-muted small">
                                Pourcentage de bonnes réponses sur l’ensemble des tentatives
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Questions -->
                <div class="col-md-6">
                    <div class="card shadow border-0 h-100">
                        <div class="card-body text-center p-4">
                            <h5 class="card-title mb-4 fw-medium">Questions</h5>
                            <div style="height: 290px;">
                                <canvas id="questionsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Réponses -->
                <div class="col-md-6">
                    <div class="card shadow border-0 h-100">
                        <div class="card-body text-center p-4">
                            <h5 class="card-title mb-4 fw-medium">Réponses</h5>
                            <div style="height: 290px;">
                                <canvas id="reponsesChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

<!-- Dépendances -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<script>
// Configuration Chart.js globale
Chart.defaults.font.family = "'Segoe UI', system-ui, sans-serif";
Chart.defaults.plugins.legend.labels.usePointStyle = true;
Chart.defaults.plugins.legend.labels.padding = 20;

document.addEventListener('DOMContentLoaded', () => {

    const total = {{ totalReponses }};
    const bonnes = {{ bonnesReponses }};
    const taux = total > 0 ? ((bonnes / total) * 100).toFixed(1) : 0;

    // Taux de réussite - doughnut principal
    new Chart(document.getElementById('tauxReussiteChart'), {
        type: 'doughnut',
        data: {
            labels: ['Réussite', 'Échec'],
            datasets: [{
                data: [bonnes, total - bonnes],
                backgroundColor: ['#198754', '#dc3545'],
                borderWidth: 4,
                borderColor: '#ffffff',
                hoverOffset: 24
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '68%',
            animation: { duration: 1600, easing: 'easeOutCubic' },
            plugins: {
                legend: { position: 'bottom', labels: { font: { size: 14 } } },
                title: {
                    display: true,
                    text: taux + '% de réussite',
                    font: { size: 24, weight: '600' },
                    padding: { top: 10, bottom: 20 }
                },
                tooltip: {
                    callbacks: {
                        label: (ctx) => {
                            const val = ctx.raw;
                            const pct = total > 0 ? ((val / total) * 100).toFixed(1) : 0;
                            return ` ${ctx.label} : ${val} (${pct}%)`;
                        }
                    }
                }
            }
        }
    });

    // Questions valides / invalides
    new Chart(document.getElementById('questionsChart'), {
        type: 'doughnut',
        data: {
            labels: ['Valides', 'Invalides'],
            datasets: [{
                data: [{{ questionsValides }}, {{ questionsInvalides }}],
                backgroundColor: ['#2e7d32', '#c62828'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '62%',
            plugins: {
                legend: { position: 'bottom' },
                title: { display: true, text: 'État des questions', font: { size: 17 } }
            }
        }
    });

    // Réponses total / bonnes
    new Chart(document.getElementById('reponsesChart'), {
        type: 'bar',
        data: {
            labels: ['Total', 'Bonnes'],
            datasets: [{
                data: [total, bonnes],
                backgroundColor: ['rgba(33, 150, 243, 0.65)', 'rgba(76, 175, 80, 0.65)'],
                borderColor: ['#2196f3', '#4caf50'],
                borderWidth: 2,
                borderRadius: 8,
                categoryPercentage: 0.55
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                title: { display: true, text: 'Réponses', font: { size: 17 } }
            },
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } }
            }
        }
    });
});
</script>
{% endblock %}
